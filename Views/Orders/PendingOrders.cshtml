@model List<OrderManagementSystem.Models.Entities.Order>
@{
    ViewData["Title"] = "Pending Orders - Review & Send";
}

<style>
    .order-card {
        border-left: 5px solid #ffc107;
        transition: all 0.3s;
    }

        .order-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .order-card.sent {
            border-left-color: #28a745;
            opacity: 0.7;
        }

    .editable-field {
        border: 2px dashed #dee2e6;
        padding: 8px;
        border-radius: 4px;
        background: #f8f9fa;
    }

        .editable-field:focus {
            border-color: #667eea;
            background: white;
        }

    .required-badge {
        color: #dc3545;
        font-weight: bold;
    }
</style>

<div class="container-fluid">
    <!-- Stats -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card shadow-sm border-0 bg-warning text-white">
                <div class="card-body">
                    <h6>Pending Orders</h6>
                    <h2 class="mb-0">@Model.Count(o => !o.SentToSteadfast)</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-0 bg-success text-white">
                <div class="card-body">
                    <h6>Sent to Steadfast</h6>
                    <h2 class="mb-0">@Model.Count(o => o.SentToSteadfast)</h2>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-body">
                    <input type="text" id="searchInput" class="form-control" placeholder="Search orders..." />
                </div>
            </div>
        </div>
    </div>

    <!-- Orders List -->
    @if (Model.Any())
    {
        @foreach (var order in Model)
        {
            <div class="card shadow-sm mb-4 order-card @(order.SentToSteadfast ? "sent" : "")" id="order-@order.Id">
                <div class="card-header @(order.SentToSteadfast ? "bg-success" : "bg-warning") text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-box-seam"></i> @order.OrderNumber
                            @if (order.SentToSteadfast)
                            {
                                <span class="badge bg-light text-success ms-2">
                                    <i class="bi bi-check-circle"></i> Sent to Steadfast
                                </span>
                            }
                        </h5>
                        <div>
                            <small>Created: @order.CreatedAt.ToLocalTimeString("MMM dd, hh:mm tt")</small>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <form class="steadfast-form" data-order-id="@order.Id">
                        <div class="row">
                            <!-- Left Column -->
                            <div class="col-md-6">
                                <h6 class="border-bottom pb-2 mb-3">
                                    <i class="bi bi-person-fill text-primary"></i> Customer Information
                                    <span class="required-badge">* Required</span>
                                </h6>

                                <div class="mb-3">
                                    <label class="form-label">
                                        Invoice/Order Number <span class="required-badge">*</span>
                                    </label>
                                    <input type="text"
                                           name="invoice"
                                           class="form-control editable-field"
                                           value="@order.OrderNumber"
                                           required
                                           readonly />
                                    <small class="text-muted">Auto-filled, cannot be changed</small>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">
                                        Recipient Name <span class="required-badge">*</span>
                                    </label>
                                    <input type="text"
                                           name="recipient_name"
                                           class="form-control editable-field"
                                           value="@order.CustomerName"
                                           required />
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">
                                        Recipient Phone <span class="required-badge">*</span>
                                    </label>
                                    <input type="text"
                                           name="recipient_phone"
                                           class="form-control editable-field"
                                           value="@order.CustomerPhone"
                                           pattern="01\d{9}"
                                           required />
                                    <small class="text-muted">Must be 11 digits (01XXXXXXXXX)</small>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Alternative Phone</label>
                                    <input type="text"
                                           name="alternative_phone"
                                           class="form-control editable-field"
                                           value="@order.AlternativePhone"
                                           pattern="01\d{9}" />
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Recipient Email</label>
                                    <input type="email"
                                           name="recipient_email"
                                           class="form-control editable-field"
                                           value="@order.RecipientEmail" />
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">
                                        Delivery Address <span class="required-badge">*</span>
                                    </label>
                                    <textarea name="recipient_address"
                                      class="form-control editable-field"
                                      rows="3"
                                      required>@order.CustomerAddress</textarea>
                                    <small class="text-muted">Maximum 250 characters</small>
                                </div>
                            </div>

                            <!-- Right Column -->
                            <div class="col-md-6">
                                <h6 class="border-bottom pb-2 mb-3">
                                    <i class="bi bi-box text-success"></i> Order Details
                                </h6>

                                <div class="mb-3">
                                    <label class="form-label">
                                        COD Amount (৳) <span class="required-badge">*</span>
                                    </label>
                                    <input type="number"
                                           name="cod_amount"
                                           class="form-control editable-field"
                                           value="@order.TotalAmount"
                                           step="0.01"
                                           min="0"
                                           required />
                                    <small class="text-muted">Cash on Delivery amount</small>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Item Description</label>
                                    <textarea name="item_description"
                                      class="form-control editable-field"
                                      rows="2">@(order.Items != null && order.Items.Any() ? string.Join(", ", order.Items.Select(i => i.ProductName)) : order.ProductName)</textarea>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Total Lot (Number of Items)</label>
                                    <input type="number"
                                           name="total_lot"
                                           class="form-control editable-field"
                                           value="@(order.Items?.Count ?? 1)"
                                           min="1" />
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Delivery Type</label>
                                    <select name="delivery_type" class="form-select editable-field">
                                        <option value="0">Home Delivery</option>
                                        <option value="1">Point Delivery / Steadfast Hub Pickup</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Delivery Note</label>
                                    <textarea name="note"
                                      class="form-control editable-field"
                                      rows="2">@order.OrderNotes</textarea>
                                    <small class="text-muted">Delivery instructions</small>
                                </div>

                                <!-- Steadfast Info (if sent) -->
                                @if (order.SentToSteadfast)
                                {
                                    <div class="alert alert-success">
                                        <strong><i class="bi bi-check-circle"></i> Steadfast Details:</strong><br>
                                        <strong>Consignment ID:</strong> @order.SteadfastConsignmentId<br>
                                        <strong>Tracking Code:</strong>
                                        <span class="badge bg-primary">@order.SteadfastTrackingCode</span><br>
                                        <strong>Status:</strong> @order.SteadfastStatus<br>
                                        <strong>Sent At:</strong> @order.SentToSteadfastAt?.ToLocalTimeString()
                                        <br>
                                        <button type="button" class="btn btn-sm btn-info mt-2" onclick="checkStatus('@order.SteadfastTrackingCode', '@order.Id')">
                                            <i class="bi bi-arrow-repeat"></i> Refresh Status
                                        </button>
                                    </div>
                                }
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <a asp-action="Details" asp-route-id="@order.Id" class="btn btn-outline-primary" target="_blank">
                                            <i class="bi bi-eye"></i> View Full Details
                                        </a>
                                    </div>
                                    <div>
                                        @if (!order.SentToSteadfast)
                                        {
                                            <button type="button" class="btn btn-success btn-lg" onclick="sendToSteadfast(this)">
                                                <i class="bi bi-send"></i> Send to Steadfast
                                            </button>
                                        }
                                        else
                                        {
                                            <button type="button" class="btn btn-secondary" disabled>
                                                <i class="bi bi-check-circle"></i> Already Sent
                                            </button>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        }
    }
    else
    {
        <div class="text-center py-5">
            <i class="bi bi-inbox" style="font-size: 4rem; color: #ccc;"></i>
            <p class="text-muted mt-3">No pending orders</p>
            <a asp-action="Index" class="btn btn-primary">
                <i class="bi bi-list"></i> View All Orders
            </a>
        </div>
    }
</div>

@section Scripts {
    <script>
        // Search functionality
        document.getElementById('searchInput').addEventListener('keyup', function() {
            const searchValue = this.value.toLowerCase();
            const cards = document.querySelectorAll('.order-card');

            cards.forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(searchValue) ? '' : 'none';
            });
        });

        // Send to Steadfast
        function sendToSteadfast(button) {
            const form = button.closest('form');
            const orderId = form.dataset.orderId;
            const formData = new FormData(form);

            // Validate required fields
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            // Prepare request data
            const requestData = {
                invoice: formData.get('invoice'),
                recipient_name: formData.get('recipient_name'),
                recipient_phone: formData.get('recipient_phone'),
                recipient_address: formData.get('recipient_address'),
                cod_amount: parseFloat(formData.get('cod_amount')),
                note: formData.get('note') || null,
                alternative_phone: formData.get('alternative_phone') || null,
                recipient_email: formData.get('recipient_email') || null,
                item_description: formData.get('item_description') || null,
                total_lot: formData.get('total_lot') ? parseInt(formData.get('total_lot')) : null,
                delivery_type: parseInt(formData.get('delivery_type'))
            };

            if (!confirm('⚠️ Confirm sending this order to Steadfast Courier?\n\nMake sure all information is correct.')) {
                return;
            }

            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Sending...';

            $.ajax({
                url: '@Url.Action("SendToSteadfast", "Orders")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    orderId: orderId,
                    request: requestData
                }),
                success: function(response) {
                    if (response.success) {
                        showToast('Success', `Order sent to Steadfast! Tracking Code: ${response.trackingCode}`, 'success');

                        // Mark card as sent
                        const card = document.getElementById('order-' + orderId);
                        card.classList.add('sent');

                        // Reload page after 2 seconds
                        setTimeout(function() {
                            location.reload();
                        }, 2000);
                    } else {
                        showToast('Error', response.message, 'danger');
                        button.disabled = false;
                        button.innerHTML = '<i class="bi bi-send"></i> Send to Steadfast';
                    }
                },
                error: function(xhr) {
                    showToast('Error', 'Failed to send order. Please try again.', 'danger');
                    button.disabled = false;
                    button.innerHTML = '<i class="bi bi-send"></i> Send to Steadfast';
                }
            });
        }

        // Check Steadfast status
        function checkStatus(trackingCode, orderId) {
            $.ajax({
                url: '@Url.Action("CheckSteadfastStatus", "Orders")',
                type: 'GET',
                data: { trackingCode: trackingCode },
                success: function(response) {
                    if (response.success) {
                        showToast('Status Updated', `Current Status: ${response.status}`, 'info');
                    } else {
                        showToast('Error', response.message, 'danger');
                    }
                }
            });
        }

        // Toast notification
        function showToast(title, message, type) {
            const toastHtml = `
                <div class="toast align-items-center text-white bg-${type} border-0" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                    <div class="d-flex">
                        <div class="toast-body">
                            <strong>${title}:</strong> ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;

            const toastElement = $(toastHtml).appendTo('body');
            const toast = new bootstrap.Toast(toastElement[0], { delay: 5000 });
            toast.show();

            toastElement.on('hidden.bs.toast', function() {
                $(this).remove();
            });
        }
    </script>
}